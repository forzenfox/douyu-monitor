# 自定义弹幕展示区需求设计文档

## 1. 功能概述

新增一个自定义弹幕展示区，用于展示符合特定规则的弹幕内容。符合规则的弹幕将同时在普通弹幕区域和自定义弹幕区域展示，不会被过滤。同时新增一个配置页签，用于配置自定义弹幕区的展示规则。

## 2. 功能需求

### 2.1 自定义弹幕展示区
- **展示功能**：创建独立的自定义弹幕展示区域，支持多种展示样式
- **弹幕同步**：符合规则的弹幕需同时在普通弹幕区和自定义弹幕区展示
- **实时更新**：自定义弹幕区需实时接收并展示符合规则的新弹幕
- **历史记录**：支持查看最近符合规则的弹幕历史记录
- **样式定制**：支持配置自定义弹幕区的字体大小、颜色、背景等样式

### 2.2 自定义弹幕规则配置
- **关键词匹配**：支持配置关键词列表，包含关键词的弹幕将被展示
- **正则表达式**：支持使用正则表达式匹配弹幕内容
- **用户等级限制**：支持根据用户等级过滤弹幕
- **礼物等级限制**：支持根据礼物等级过滤弹幕
- **弹幕类型过滤**：支持根据弹幕类型（普通弹幕、礼物弹幕、超级弹幕等）过滤
- **规则组合**：支持多个规则的组合使用（AND/OR逻辑）
- **规则管理**：支持添加、编辑、删除规则
- **规则启用/禁用**：支持单独启用或禁用某个规则

### 2.3 配置页签
- **新增配置页**：在现有配置界面中新增一个自定义弹幕配置页签
- **规则列表**：展示所有已配置的规则，包含规则名称、类型、状态等信息
- **规则编辑器**：提供友好的规则编辑界面，支持实时预览规则效果
- **配置保存**：支持保存配置到本地存储，刷新页面后配置不丢失
- **配置导入/导出**：支持配置的导入和导出功能

## 3. 技术设计

### 3.1 组件设计

| 组件名称 | 功能描述 | 文件路径 |
|---------|---------|----------|
| CustomDanmaku | 自定义弹幕展示主组件 | src/packages/Monitor/components/CustomDanmaku/CustomDanmaku.vue |
| CustomDanmakuItem | 自定义弹幕项组件 | src/packages/Monitor/components/CustomDanmaku/templates/Default.vue |
| CustomDanmakuConfig | 自定义弹幕配置组件 | src/packages/Monitor/components/CustomDanmaku/CustomDanmakuConfig.vue |
| RuleEditor | 规则编辑器组件 | src/packages/Monitor/components/CustomDanmaku/RuleEditor.vue |

### 3.2 数据结构设计

#### 3.2.1 自定义弹幕规则数据结构

```javascript
// 自定义弹幕规则配置
const customDanmakuRules = {
  enabled: true, // 是否启用自定义弹幕区
  displayCount: 10, // 自定义弹幕区显示数量
  displayStyle: 'scroll', // 展示样式：scroll(滚动), list(列表), fade(淡入淡出)
  styles: { // 样式配置
    fontSize: '16px',
    color: '#ffffff',
    backgroundColor: 'rgba(0, 0, 0, 0.7)',
    border: '1px solid #333333',
    borderRadius: '4px',
    padding: '8px'
  },
  rules: [ // 规则列表
    {
      id: 'rule-1',
      name: '关键词规则',
      type: 'keyword', // 规则类型：keyword(关键词), regex(正则), level(等级), gift(礼物)
      enabled: true,
      logic: 'OR', // 规则间逻辑关系：AND, OR
      conditions: [ // 规则条件
        {
          key: 'content',
          operator: 'contains', // 操作符：contains(包含), equals(等于), startsWith(开头), endsWith(结尾)
          value: ['关键词1', '关键词2']
        }
      ]
    },
    {
      id: 'rule-2',
      name: '正则规则',
      type: 'regex',
      enabled: true,
      logic: 'AND',
      conditions: [
        {
          key: 'content',
          operator: 'matches', // 操作符：matches(匹配)
          value: '正则表达式'
        }
      ]
    }
  ]
};
```

#### 3.2.2 自定义弹幕数据结构

```javascript
// 自定义弹幕数据结构
const customDanmakuData = {
  id: 'danmaku-123456', // 弹幕ID
  userId: 'user-123', // 用户ID
  userName: '用户名', // 用户名
  userLevel: 50, // 用户等级
  content: '弹幕内容', // 弹幕内容
  type: 'normal', // 弹幕类型：normal(普通), gift(礼物), superchat(超级弹幕)
  giftLevel: 0, // 礼物等级(0表示非礼物弹幕)
  timestamp: 1620000000000, // 发送时间戳
  matchedRule: 'rule-1' // 匹配的规则ID
};
```

### 3.3 技术实现方案

#### 3.3.1 弹幕过滤机制

1. **接收弹幕**：通过WebSocket接收原始弹幕数据
2. **规则匹配**：将接收到的弹幕与自定义规则进行匹配
3. **双路分发**：
   - 匹配成功的弹幕：同时发送到普通弹幕区和自定义弹幕区
   - 匹配失败的弹幕：只发送到普通弹幕区
4. **历史存储**：将匹配成功的弹幕存储到历史记录中，限制最大存储数量

#### 3.3.2 规则匹配算法

```javascript
// 规则匹配核心逻辑
function matchDanmakuRule(danmaku, rule) {
  // 如果规则未启用，直接返回false
  if (!rule.enabled) return false;
  
  // 根据规则类型执行不同的匹配逻辑
  switch (rule.type) {
    case 'keyword':
      return matchKeywordRule(danmaku, rule.conditions, rule.logic);
    case 'regex':
      return matchRegexRule(danmaku, rule.conditions, rule.logic);
    case 'level':
      return matchLevelRule(danmaku, rule.conditions, rule.logic);
    case 'gift':
      return matchGiftRule(danmaku, rule.conditions, rule.logic);
    default:
      return false;
  }
}
```

#### 3.3.3 配置持久化

- **本地存储**：使用localStorage存储自定义弹幕配置
- **配置同步**：配置变更时实时保存到本地存储
- **初始配置**：提供默认配置，首次使用时自动加载

## 4. UI设计

### 4.1 自定义弹幕展示区

- **位置**：可配置，支持顶部、底部、左侧、右侧等位置
- **大小**：可配置，支持固定大小或百分比大小
- **样式**：
  - 滚动样式：弹幕从右向左滚动显示
  - 列表样式：以列表形式展示，支持自动滚动
  - 淡入淡出样式：新弹幕淡入，旧弹幕淡出
- **交互**：支持点击弹幕查看详情，支持鼠标悬停显示完整内容

### 4.2 配置页签设计

- **布局**：采用与现有配置页签一致的布局风格
- **规则列表**：
  - 表格形式展示所有规则
  - 包含规则名称、类型、状态、操作按钮
  - 支持规则的启用/禁用、编辑、删除操作
- **规则编辑器**：
  - 模态框形式，支持添加/编辑规则
  - 表单设计，根据规则类型动态显示不同的配置项
  - 实时预览匹配效果
  - 支持规则条件的添加、编辑、删除

## 5. 实现步骤

1. **组件开发**：
   - 创建CustomDanmaku组件，实现自定义弹幕展示功能
   - 创建CustomDanmakuConfig组件，实现规则配置功能
   - 创建RuleEditor组件，实现规则编辑功能

2. **规则引擎开发**：
   - 实现规则匹配核心逻辑
   - 支持多种规则类型和操作符
   - 实现规则组合逻辑

3. **数据管理**：
   - 实现自定义弹幕数据的存储和管理
   - 实现配置数据的持久化存储

4. **UI集成**：
   - 将自定义弹幕区集成到主页面
   - 将配置页签集成到现有配置界面

5. **测试验证**：
   - 测试规则匹配的准确性
   - 测试弹幕同步的实时性
   - 测试配置的保存和加载功能
   - 测试各种样式的展示效果

## 6. 扩展性设计

- **支持插件化**：设计插件接口，支持第三方扩展规则类型
- **支持多区域**：后续可扩展支持多个自定义弹幕展示区域
- **支持数据分析**：后续可扩展支持自定义弹幕的数据统计和分析功能
- **支持云同步**：后续可扩展支持配置的云端同步功能

## 7. 性能考虑

- **规则匹配优化**：使用高效的规则匹配算法，避免性能瓶颈
- **弹幕数量限制**：限制自定义弹幕区的最大显示数量和历史记录数量
- **异步处理**：规则匹配逻辑采用异步处理，避免阻塞主线程
- **内存管理**：及时清理过期的弹幕数据，避免内存泄漏

## 8. 兼容性考虑

- **浏览器兼容性**：确保在主流浏览器（Chrome、Firefox、Safari、Edge）中正常工作
- **响应式设计**：适配不同屏幕尺寸
- **移动端支持**：确保在移动设备上有良好的显示效果

## 9. 风险评估

- **性能风险**：复杂规则可能导致匹配性能问题，需进行性能优化
- **规则冲突**：多个规则可能产生冲突，需设计合理的规则优先级机制
- **配置错误**：用户可能配置错误的规则，需提供友好的错误提示和验证
- **数据量过大**：大量符合规则的弹幕可能导致界面卡顿，需设计合理的显示策略

## 10. 后续迭代计划

- **版本1.0**：实现基本的自定义弹幕展示和关键词规则配置
- **版本1.1**：添加正则表达式支持和规则组合功能
- **版本1.2**：添加用户等级和礼物等级过滤功能
- **版本1.3**：添加样式定制和多区域支持
- **版本1.4**：添加数据分析和云同步功能

## 11. 结论

本需求设计文档详细描述了自定义弹幕展示区的功能需求、技术设计、数据结构和UI设计等方面。通过实现这些功能，可以为用户提供更加灵活和个性化的弹幕展示体验，满足不同场景下的弹幕监控需求。