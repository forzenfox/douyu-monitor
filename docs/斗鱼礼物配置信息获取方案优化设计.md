# 斗鱼礼物配置信息获取方案优化设计

## 现有方案分析

### 1. 当前实现
- **静态数据存储**：`src/global/utils/dydata/giftData.js` 中定义空对象 `giftData` 用于存储礼物配置
- **手动更新机制**：通过 `scripts/getBagGift.js` 脚本手动获取数据，然后粘贴到代码中
- **单一数据源**：仅从 `http://webconf.douyucdn.cn/resource/common/prop_gift_list/prop_gift_config.json` 获取数据
- **无缓存机制**：每次更新需要手动操作，缺乏自动更新和缓存策略

### 2. 存在问题
- **实时性差**：礼物数据更新依赖手动操作，无法及时获取最新数据
- **维护成本高**：每次更新需要手动执行脚本并修改代码
- **容错性差**：API请求失败或数据格式变化会影响整个系统
- **功能受限**：仅获取基础礼物数据，缺少特效、皮肤等丰富信息

## 优化设计方案

### 1. 核心优化点

#### 1.1 兼容静态部署的动态数据获取
- **构建时数据获取**：在构建阶段自动从API获取最新礼物数据，生成静态文件
- **运行时动态更新**：利用现有roomId（从URL路径获取），在运行时异步获取当前房间的礼物数据
- **多环境支持**：支持开发环境动态获取，生产环境优先使用构建时生成的静态数据

#### 1.2 数据结构优化
- 优化礼物数据存储结构，便于快速查询
- 支持礼物分类、皮肤、特效等扩展信息
- 添加索引，提高数据访问效率

#### 1.3 缓存与容错机制
- 实现构建时缓存，减少API请求次数
- 添加本地备份，当运行时API不可用时自动切换到静态数据
- 实现数据验证，确保获取的数据格式正确

#### 1.4 模块化设计
- 将礼物数据获取功能封装为独立模块
- 提供清晰的API接口，便于其他模块使用
- 支持按需加载，减少初始加载时间

### 2. 详细设计

#### 2.1 数据源设计

| 数据源类型 | API地址 | 功能描述 | 更新频率 |
|------------|---------|----------|----------|
| 主数据源 | `https://gift.douyucdn.cn/api/gift/v5/web/list?rid={roomId}` | 获取房间礼物列表 | 构建时 + 运行时按需 |
| 辅助数据源 | `https://gift.douyucdn.cn/api/gift/v1/web/commonConfig?` | 获取公共配置 | 构建时 |
| 备用数据源 | `http://webconf.douyucdn.cn/resource/common/prop_gift_list/prop_gift_config.json` | 获取备用礼物数据 | 构建时 |

#### 2.2 数据结构设计

```javascript
// 礼物数据结构
export interface GiftData {
  [giftId: string]: {
    id: string;          // 礼物ID
    name: string;        // 礼物名称
    price: number;       // 礼物价格（单位：分）
    type: number;        // 礼物类型
    icon: string;        // 礼物图标URL
    skinData?: {
      [skinId: string]: {
        skinId: string;
        name: string;
        icon: string;
      }
    };
    onceLimit?: number;  // 单次送礼限制
  }
}

// 礼物配置结构
export interface GiftConfig {
  version: string;      // 数据版本
  updateTime: number;   // 更新时间戳
  giftData: GiftData;   // 礼物数据
  tabs: Array<{
    id: number;
    name: string;
    giftIds: string[];
  }>;                   // 礼物分类标签
  commonConfig: {
    picUrlPrefix: string;  // 图片URL前缀
    banners: Array<{
      id: number;
      img: string;
      link: string;
    }>;                   // 横幅配置
  };
}
```

#### 2.3 实现架构

```
┌─────────────────────────────────────────────────────────────┐
│                        礼物数据模块                          │
├─────────────┬─────────────┬─────────────┬─────────────────┤
│  构建时处理   │  运行时处理   │  数据存储层   │  对外接口层    │
├─────────────┼─────────────┼─────────────┼─────────────────┤
│  - API请求   │  - 数据验证   │  - 静态文件   │  - 获取礼物数据 │
│  - 数据生成   │  - 版本检查   │  - 内存缓存   │  - 监听数据变化 │
│  - 静态文件输出│  - 异步更新   │  - 本地存储   │                │
└─────────────┴─────────────┴─────────────┴─────────────────┘
```

#### 2.4 核心功能实现

1. **构建时数据生成**
   - 实现构建脚本，在构建阶段自动从API获取最新礼物数据
   - 生成静态数据文件 `src/global/utils/dydata/giftData.generated.js`
   - 包含版本信息和完整礼物数据

2. **运行时数据处理**
   - 利用现有roomId（从URL路径获取），在页面加载时自动获取当前房间的礼物数据
   - 优先使用构建时生成的静态数据，然后异步更新为当前房间的专属数据
   - 实现数据验证，确保数据格式正确
   - 兼容现有 `window.rid` 全局变量

3. **双模式支持**
   - **开发模式**：动态获取最新数据，便于开发调试
   - **生产模式**：优先使用构建时生成的静态数据，确保部署兼容性

4. **API接口设计**
   ```javascript
   // 获取所有礼物数据
   export function getAllGiftData() {}
   
   // 根据ID获取礼物数据
   export function getGiftById(giftId) {}
   
   // 手动触发数据更新
   export function refreshGiftData() {}
   
   // 监听数据更新事件
   export function onGiftDataUpdate(callback) {}
   ```

### 3. 代码结构设计

```
src/
└── global/
    └── utils/
        └── dydata/
            ├── giftData.js              // 礼物数据存储（导出函数，兼容原有接口）
            ├── giftData.generated.js    // 构建时生成的静态数据（.gitignore）
            ├── giftApi.js               // API请求模块
            ├── giftManager.js           // 礼物数据管理主模块
            └── giftHelper.js            // 辅助函数
└── scripts/
    ├── getBagGift.js                    // 原有手动更新脚本（保留）
    └── generateGiftData.js              // 构建时数据生成脚本
```

### 4. 构建流程设计

```
1. 执行构建命令
2. 运行 `generateGiftData.js` 脚本
   - 从多个API获取礼物数据
   - 合并并处理数据
   - 生成 `giftData.generated.js` 文件
3. 执行正常构建流程
4. 生成的静态文件包含完整的礼物数据
```

### 5. 与现有代码集成

1. **修改 `giftData.js`**
   - 导出动态获取礼物数据的函数，兼容原有接口
   - 优先使用运行时获取的数据，备用使用静态数据

2. **利用现有 `updateGiftData` 函数**
   - 扩展 `src/monitor/pages/index.vue` 中的 `updateGiftData` 函数
   - 将获取的礼物数据存储到全局状态中
   - 实现定时更新机制

3. **修改 `useWebsocket.js`**
   - 从全局状态获取礼物数据，替换静态 `allGiftData` 参数
   - 监听礼物数据更新事件，实时更新礼物信息

4. **组件使用**
   ```javascript
   import { getAllGiftData, getGiftById } from '@/global/utils/dydata/giftManager';
   
   // 使用方式
   const allGiftData = getAllGiftData();
   const gift = getGiftById('123');
   ```

### 6. 静态部署兼容性

- **无API依赖**：生产环境优先使用构建时生成的静态数据
- **构建时生成**：所有数据在构建阶段生成，确保部署包包含完整数据
- **无需服务器支持**：纯静态文件，可部署在任何静态托管服务
- **向后兼容**：与现有代码结构兼容，无需重构现有组件

### 7. 性能优化

- **静态数据加载**：生产环境直接加载静态文件，加载速度快
- **按需导入**：支持ES模块按需导入，减少初始加载体积
- **缓存优化**：构建时数据版本化，便于浏览器缓存
- **数据压缩**：生成的静态数据进行压缩，减少文件大小

## 实施计划

1. **第1阶段**：实现构建时数据生成脚本
2. **第2阶段**：修改礼物数据模块，支持双模式
3. **第3阶段**：扩展现有 `updateGiftData` 函数
4. **第4阶段**：集成到 `useWebsocket.js` 中
5. **第5阶段**：测试构建和部署流程

## 预期效果

1. **兼容静态部署**：生产环境完全使用静态数据，不影响GitHub Pages等静态部署
2. **实时性提升**：构建时自动获取最新数据，运行时可按需更新
3. **维护成本降低**：自动化数据更新，减少手动操作
4. **功能丰富**：获取更完整的礼物数据，支持分类、皮肤等信息
5. **性能优化**：静态数据加载速度快，减少运行时开销

## 部署影响评估

### 1. 对GitHub Pages部署的影响
- **正面影响**：
  - 构建时生成完整数据，无需服务器支持
  - 减少客户端请求，提高页面加载速度
  - 提高系统稳定性，不依赖第三方API
- **无负面影响**：
  - 不增加部署包大小（数据压缩后体积可控）
  - 不改变现有部署流程
  - 兼容所有静态托管服务

### 2. 对CI/CD流程的影响
- **需添加构建步骤**：在CI/CD流程中添加数据生成步骤
- **不影响现有测试**：与现有测试流程兼容
- **提高部署可靠性**：构建时验证数据完整性

## 风险控制

1. **API请求失败**：
   - 实现多API备份机制
   - 失败时使用上次生成的数据
   - 添加重试逻辑

2. **数据格式变化**：
   - 实现数据验证机制
   - 添加向后兼容处理
   - 保留手动更新选项

3. **构建时间增加**：
   - 优化API请求，并行获取数据
   - 实现增量更新机制
   - 缓存API响应

通过以上优化设计，我们可以实现一个既兼容静态部署，又能提高礼物数据实时性和完整性的方案，同时保持系统的稳定性和性能。