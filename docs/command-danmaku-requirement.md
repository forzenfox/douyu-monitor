# 指令弹幕展示区需求设计文档

## 1. 功能概述

在团播场景中，用户经常通过特定指令（如 #点歌 #转盘）与主播互动，但在弹幕过多时容易遗漏。为提升互动效果，新增一个指令弹幕展示区，专门展示符合规则的指令弹幕，同时在普通弹幕区保持原样显示。通过配置页签可灵活设置指令规则，实现精准的指令识别和展示。

## 2. 功能需求

### 2.1 指令弹幕展示区
- **独立展示**：创建独立的指令弹幕展示区域，与现有弹幕区并行
- **双端展示**：符合规则的弹幕同时在普通弹幕区和指令弹幕区显示
- **实时更新**：实时接收并展示符合规则的新指令弹幕
- **历史记录**：支持查看最近的指令弹幕历史，可配置最大显示数量（10-50条）
- **样式定制**：支持配置字体大小、颜色、背景等基础样式
- **展示效果**：默认列表样式，最新弹幕置顶
- **交互体验**：鼠标悬停显示完整内容

### 2.2 指令弹幕规则配置
- **简化规则**：仅保留关键词匹配，去掉复杂的正则表达式和组合规则
- **关键词列表**：支持添加常用指令关键词，如 "点歌"、"转盘" 等
- **预设模板**：提供常见指令模板（点歌、转盘、抽奖、投票），一键添加
- **规则管理**：支持添加、删除关键词，启用/禁用规则
- **前缀设置**：支持配置统一指令前缀（如 #、！），默认使用 #

### 2.3 配置页签
- **新增页签**：在现有配置界面中新增"指令弹幕"配置页签
- **开关控制**：一键开关指令弹幕展示区
- **简单配置**：直观的表单设计，避免复杂操作
- **实时保存**：配置自动保存，无需手动提交
- **预览效果**：配置变更时实时预览效果

## 3. 技术设计

### 3.1 组件设计

| 组件名称 | 功能描述 | 文件路径 |
|---------|---------|----------|
| CommandDanmaku | 指令弹幕展示主组件 | src/packages/Monitor/components/CommandDanmaku/CommandDanmaku.vue |
| CommandDanmakuItem | 指令弹幕项组件 | src/packages/Monitor/components/CommandDanmaku/templates/Default.vue |
| CommandDanmakuConfig | 指令弹幕配置组件 | src/packages/Monitor/components/CommandDanmaku/CommandDanmakuConfig.vue |

### 3.2 数据结构设计

#### 3.2.1 指令弹幕配置数据结构（简化版）

```javascript
// 指令弹幕配置（简化版）
const commandDanmaku = {
  // 模块开关
  enabled: true,
  // 最大显示数量
  maxCount: 20,
  // 指令前缀
  prefix: '#',
  // 样式配置
  styles: {
    fontSize: 16,
    color: '#ffffff',
    backgroundColor: 'rgba(0, 123, 255, 0.8)',
    border: '1px solid #007bff',
    borderRadius: '8px',
    padding: '10px',
    margin: '5px'
  },
  // 指令关键词列表
  keywords: [
    {
      id: 'kw-1',
      name: '点歌',
      enabled: true
    },
    {
      id: 'kw-2',
      name: '转盘',
      enabled: true
    },
    {
      id: 'kw-3',
      name: '抽奖',
      enabled: false
    }
  ]
};
```

#### 3.2.2 指令弹幕数据结构

```javascript
// 指令弹幕数据结构
const commandDanmakuItem = {
  id: 'danmaku-123456', // 唯一标识
  userId: 'user-123', // 用户ID
  userName: '用户名', // 用户名
  userLevel: 50, // 用户等级
  content: '#点歌 青花瓷', // 完整弹幕内容
  command: '点歌', // 指令类型
  commandContent: '青花瓷', // 指令内容
  timestamp: 1620000000000, // 发送时间戳
  // 用户相关信息
  userInfo: {
    avatar: 'avatar-url',
    fansLevel: 10
  }
};
```

### 3.3 技术实现方案

#### 3.3.1 弹幕处理流程（简化版）

1. **接收弹幕**：通过WebSocket接收原始弹幕数据
2. **规则匹配**：检查弹幕是否以配置的前缀开头，且包含配置的关键词
3. **双路分发**：
   - 匹配成功：同时发送到普通弹幕区和指令弹幕区
   - 匹配失败：只发送到普通弹幕区
4. **数据存储**：将指令弹幕存储到历史记录中，超过最大数量时自动清理
5. **UI更新**：实时更新指令弹幕展示区

#### 3.3.2 规则匹配算法（简化版）

```javascript
// 规则匹配核心逻辑（简化版）
function matchCommandRule(danmaku, config) {
  // 检查是否以指定前缀开头
  if (!danmaku.content.startsWith(config.prefix)) {
    return { matched: false };
  }
  
  // 获取前缀后的内容
  const contentAfterPrefix = danmaku.content.slice(config.prefix.length);
  
  // 检查是否包含任何启用的关键词
  for (const keyword of config.keywords) {
    if (keyword.enabled && contentAfterPrefix.includes(keyword.name)) {
      // 提取指令内容
      const commandContent = contentAfterPrefix.replace(keyword.name, '').trim();
      
      return {
        matched: true,
        command: keyword.name,
        commandContent
      };
    }
  }
  
  return { matched: false };
}
```

## 4. 具体UI设计样式

### 4.1 指令弹幕展示区（具体样式）

#### 4.1.1 整体布局
- **位置**：默认显示在页面右侧，宽度300px，高度自适应
- **间距**：与其他模块间距20px
- **背景**：半透明背景，默认rgba(0, 123, 255, 0.1)
- **边框**：1px solid #007bff，圆角8px

#### 4.1.2 弹幕项样式
- **背景色**：默认rgba(0, 123, 255, 0.8)
- **边框**：1px solid #007bff，圆角8px
- **内边距**：10px 12px
- **外边距**：底部5px
- **字体**：
  - 用户名：14px，#ffffff，加粗
  - 指令内容：14px，#ffffff
  - 时间戳：12px，#cccccc
- **布局**：
  ```
  +-----------------------------------------+
  | 用户名 (等级图标)                        |
  | 指令：#点歌 青花瓷                      |
  | [2024-01-18 12:00:00]                    |
  +-----------------------------------------+
  ```

#### 4.1.3 动态效果
- **入场动画**：淡入效果，持续300ms
- **滚动动画**：当弹幕数量超过最大显示数时，平滑滚动
- **高亮效果**：新弹幕添加时，背景色加深20%，持续2秒后恢复

### 4.2 配置页签（具体样式）

#### 4.2.1 页签布局
- **位置**：在现有配置页签后新增"指令弹幕"页签
- **样式**：与现有页签一致，激活状态背景色#007bff，文字色#ffffff

#### 4.2.2 配置项样式

| 配置项 | 样式详情 |
|-------|----------|
| **模块开关** | 开关样式：蓝色滑块，默认开启 |
| **前缀设置** | 输入框样式：宽度80px，高度36px，边框1px solid #ddd，圆角4px |
| **关键词列表** | 卡片式设计，每个关键词为一个卡片，包含名称、启用开关、删除按钮 |
| **添加关键词** | 按钮样式：背景色#007bff，文字色#ffffff，高度36px，圆角4px，hover效果：背景色#0056b3 |
| **预设模板** | 按钮组样式：每个模板为一个按钮，背景色#e9ecef，文字色#495057，高度32px，圆角4px，hover效果：背景色#dee2e6 |
| **样式配置** |
| - 字体大小 | 滑块控件：范围12-20px，默认16px |
| - 文字颜色 | 颜色选择器：默认#ffffff |
| - 背景颜色 | 颜色选择器：默认rgba(0, 123, 255, 0.8) |
| - 最大显示数 | 数字输入框：范围10-50，默认20 |

#### 4.2.3 具体布局示例
```
+-----------------------------------------+
| 指令弹幕配置                            |
+-----------------------------------------+
| [ ] 启用指令弹幕展示区                  |
+-----------------------------------------+
| 指令前缀：[ # ]                         |
+-----------------------------------------+
| 关键词列表：                            |
| +-------------------------------------+ |
| | 点歌 [启用] [删除]                  | |
| +-------------------------------------+ |
| | 转盘 [启用] [删除]                  | |
| +-------------------------------------+ |
| | 抽奖 [禁用] [删除]                  | |
| +-------------------------------------+ |
| [+ 添加关键词]                          |
+-----------------------------------------+
| 预设模板：                              |
| [点歌] [转盘] [抽奖] [投票]            |
+-----------------------------------------+
| 样式配置：                              |
| 字体大小：[滑块] 16px                   |
| 文字颜色：[颜色选择器]                  |
| 背景颜色：[颜色选择器]                  |
| 最大显示数：[20]                        |
+-----------------------------------------+
```

## 5. 模块集成设计

### 5.1 与现有系统集成

- **配置集成**：在现有options.js中新增commandDanmaku配置项
- **布局集成**：在主页面右侧添加指令弹幕区组件
- **数据集成**：复用现有WebSocket连接，共享弹幕数据流
- **样式集成**：遵循现有样式系统，支持日间/夜间模式

### 5.2 配置扩展（简化版）

```javascript
// 在options.js中扩展commandDanmaku配置（简化版）
export const defaultOptions = {
  // 现有配置...
  
  // 指令弹幕配置（简化版）
  commandDanmaku: {
    enabled: true,
    prefix: '#',
    maxCount: 20,
    keywords: [
      { id: 'kw-1', name: '点歌', enabled: true },
      { id: 'kw-2', name: '转盘', enabled: true }
    ],
    styles: {
      fontSize: 16,
      color: '#ffffff',
      backgroundColor: 'rgba(0, 123, 255, 0.8)',
      border: '1px solid #007bff',
      borderRadius: '8px',
      padding: '10px',
      margin: '5px'
    }
  }
};
```

## 6. 实现步骤

1. **组件开发**：
   - 创建CommandDanmaku组件，实现指令弹幕展示
   - 创建CommandDanmakuItem组件，实现单条弹幕渲染
   - 创建CommandDanmakuConfig组件，实现简化的配置界面

2. **规则引擎开发**：
   - 实现简化的规则匹配逻辑
   - 支持关键词匹配和前缀配置

3. **数据管理**：
   - 实现指令弹幕数据的存储和管理
   - 实现配置的本地存储和加载

4. **UI集成**：
   - 将指令弹幕区集成到主页面
   - 将配置页签集成到现有配置界面

5. **测试验证**：
   - 测试规则匹配的准确性
   - 测试弹幕同步的实时性
   - 测试配置的保存和加载功能
   - 测试各种样式的展示效果

## 7. 简化配置的设计原则

- **最少操作**：主播只需开启开关，添加关键词即可使用
- **直观易懂**：所有配置项都有明确的文字说明
- **预设模板**：提供常见指令模板，一键添加
- **实时预览**：配置变更时实时看到效果
- **避免术语**：不使用技术术语，如"正则表达式"、"优先级"等

## 8. 性能与兼容性考虑

- **规则匹配优化**：使用简单的字符串匹配，性能高效
- **弹幕数量限制**：默认限制20条，防止内存占用过高
- **浏览器兼容**：支持主流浏览器（Chrome、Firefox、Safari、Edge）
- **响应式设计**：适配不同屏幕尺寸，在小屏幕上自动调整宽度

## 9. 风险评估

- **误匹配风险**：简化的规则可能导致误匹配，需提供便捷的删除功能
- **配置丢失风险**：使用localStorage存储配置，需确保数据安全
- **性能风险**：大量指令弹幕可能导致界面卡顿，需限制最大显示数量

## 10. 结论

通过简化规则配置和提供具体的UI设计样式，该指令弹幕展示区功能将更加易用，适合主播快速上手。主播只需简单设置关键词，即可在独立的展示区看到所有指令弹幕，避免在海量弹幕中遗漏重要指令，提升直播互动效果。