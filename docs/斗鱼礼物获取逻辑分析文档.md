# 斗鱼直播礼物获取逻辑分析文档

## 1. 概述

本文档通过Playwright爬虫技术，对斗鱼直播平台（直播间ID：317422）的礼物获取逻辑进行了深入分析。主要包括礼物相关API、数据结构、获取流程等内容。

## 2. 技术分析方法

- **工具**：Playwright 1.48.0
- **分析方式**：网络请求监控 + API响应分析
- **目标直播间**：https://www.douyu.com/317422
- **分析时间**：2026-01-21

## 3. 礼物相关API列表

通过监控网络请求，共捕获116个礼物相关请求，以下是核心API：

| API类型 | URL | 功能描述 |
|---------|-----|----------|
| 礼物列表 | https://gift.douyucdn.cn/api/gift/v5/web/list?rid={roomId} | 获取直播间礼物列表 |
| 单个礼物详情 | https://gift.douyucdn.cn/api/gift/v5/web/single?gid={giftId}&skinId={skinId} | 获取单个礼物的详细信息 |
| 礼物公共配置 | https://gift.douyucdn.cn/api/gift/v1/web/commonConfig? | 获取礼物系统公共配置 |
| 直播间礼物数据 | https://www.douyu.com/japi/livebiznc/app/giftnote/data?rid={roomId} | 获取直播间礼物动态数据 |
| 礼物横幅活动配置 | https://www.douyu.com/japi/interact/web/giftBanner/giftActConfigV2?rid={roomId} | 获取礼物横幅活动配置 |
| 礼物特效配置 | https://webconf.douyucdn.cn/resource/common/gift/flash/gift_effect.json | 获取礼物特效配置 |
| 礼物模板配置 | https://wconf.douyucdn.cn/resource/common/gift/gift_template/20728.json | 获取礼物模板配置 |

## 4. 核心API响应结构分析

### 4.1 礼物列表API

**URL**：`https://gift.douyucdn.cn/api/gift/v5/web/list?rid={roomId}`

**响应结构**：
```json
{
  "data": {
    "giftList": [],      // 礼物列表数组
    "onceLimit": {},     // 单次送礼限制
    "skinData": {},      // 礼物皮肤数据
    "tabs": [],          // 礼物分类标签
    "tid": 0             // 模板ID
  },
  "error": 0,            // 错误码
  "msg": "success"       // 错误信息
}
```

### 4.2 单个礼物详情API

**URL**：`https://gift.douyucdn.cn/api/gift/v5/web/single?gid={giftId}&skinId={skinId}`

**响应结构**：
```json
{
  "data": {
    "giftList": [],      // 礼物列表（包含单个礼物详情）
    "onceLimit": {},     // 单次送礼限制
    "skinData": {},      // 礼物皮肤数据
    "tabs": [],          // 礼物分类标签
    "tid": 0             // 模板ID
  },
  "error": 0,            // 错误码
  "msg": "success"       // 错误信息
}
```

### 4.3 礼物公共配置API

**URL**：`https://gift.douyucdn.cn/api/gift/v1/web/commonConfig?`

**响应结构**：
```json
{
  "data": {
    "picUrlPrefix": "",  // 图片URL前缀
    "bannersNew": [],     // 新版横幅配置
    "combos": [],         // 礼物组合配置
    "banners": []         // 旧版横幅配置
  },
  "error": 0,            // 错误码
  "msg": "success"       // 错误信息
}
```

## 5. 礼物数据获取流程

### 5.1 页面加载阶段

1. 浏览器访问直播间URL
2. 加载页面HTML和基础资源
3. 加载礼物相关JavaScript模块（11个礼物相关JS文件）
4. 发送礼物列表API请求
5. 发送礼物公共配置API请求
6. 加载礼物特效和模板配置文件

### 5.2 礼物面板交互阶段

1. 用户点击礼物按钮
2. 发送礼物详情API请求（按需加载）
3. 加载礼物皮肤和特效资源
4. 渲染礼物面板UI

### 5.3 实时数据更新阶段

1. 定时轮询直播间礼物数据API
2. 监听礼物赠送事件
3. 实时更新礼物贡献榜
4. 触发礼物特效动画

## 6. 礼物系统技术架构

### 6.1 前端架构

- **模块化设计**：11个独立的礼物相关JavaScript模块
- **CDN加速**：礼物资源（图片、特效）通过CDN分发
- **动态加载**：礼物详情和特效按需加载
- **实时更新**：采用轮询机制获取最新礼物数据

### 6.2 后端架构

- **微服务设计**：礼物相关API独立部署
- **缓存策略**：礼物配置和列表数据缓存
- **高并发支持**：支持大量并发请求
- **CDN分发**：静态资源通过CDN加速

## 7. 礼物数据分类

### 7.1 礼物基础数据

- 礼物ID（gid）
- 礼物名称
- 礼物价格
- 礼物类型
- 礼物图标
- 礼物描述

### 7.2 礼物特效数据

- 特效类型
- 特效资源URL
- 特效播放时长
- 特效触发条件

### 7.3 礼物配置数据

- 单次送礼限制
- 礼物分类标签
- 礼物皮肤配置
- 活动横幅配置

## 8. 关键发现

1. **API版本管理**：斗鱼礼物API采用版本化设计（v1、v5等），便于迭代更新
2. **模块化资源**：礼物相关功能拆分为多个独立JS模块，按需加载
3. **CDN加速策略**：所有静态资源（图片、特效、配置文件）均通过CDN分发
4. **分层数据结构**：礼物数据分为基础数据、特效数据、配置数据等多个层次
5. **灵活的皮肤系统**：支持礼物皮肤切换，通过skinId参数控制
6. **丰富的活动配置**：支持多种礼物活动（横幅、组合礼物等）

## 9. 结论与建议

### 9.1 结论

- 斗鱼礼物系统采用了成熟的前后端分离架构
- API设计清晰，版本管理规范
- 资源加载策略优化良好，提升了页面性能
- 支持丰富的礼物类型和特效

### 9.2 建议

1. **API文档完善**：建议斗鱼官方提供完整的礼物API文档
2. **减少请求数量**：部分重复请求可以合并或缓存
3. **优化资源加载**：对于大型特效文件，建议采用预加载或按需加载策略
4. **增强错误处理**：API响应中应包含更详细的错误信息

## 10. 附录

### 10.1 礼物相关模块列表

```
live-activity-gift-hall_80353d9.js
live-activity-gift-naming_16200cf.js
live-advanced-gift_7e1f443.js
live-pubg-game-prop-shop_082634b.js
live-random-effect-gift_324af9e.js
live-random-effect-gift-v3_aa2d67c.js
live-random-effect-gift-v4_1f3770e.js
live-wishing-gift_0d6d167.js
live-random-effect-gift-preset_3d06ed2.js
live-random-effect-gift-v3-preset_b4ace2a.js
live-random-effect-gift-v4-preset_01f7d52.js
```

### 10.2 礼物配置文件列表

```
gift_template/20728.json
common_config_v2.json
rand_gift_effect_w.json
assemble_gift_w.json
giftPhotos_w.json
gift/flash/gift_effect.json
```

## 11. 分析工具与脚本

### 11.1 分析脚本

- `playwright_gift_analysis.js`：网络请求监控脚本
- `analyze_gift_api.js`：API响应分析脚本

### 11.2 依赖环境

- Node.js 24.12.0
- Playwright 1.48.0
- node-fetch 3.3.2

---

**文档生成时间**：2026-01-21
**分析人员**：AI Assistant
**技术工具**：Playwright爬虫技术
