# 斗鱼礼物数据管理使用示例

## 1. 概述

本文档展示了如何使用新实现的礼物数据管理模块，包括获取礼物数据、监听数据更新、使用辅助函数等功能。

## 2. 基本使用

### 2.1 原有接口兼容

新的礼物数据管理模块保持了向后兼容性，原有代码无需修改即可使用：

```javascript
// 原有代码无需修改，自动获取最新礼物数据
import { giftData } from '@/global/utils/dydata/giftData.js';

// 获取礼物信息
const giftInfo = giftData['20417'];
console.log('礼物名称:', giftInfo.name);
console.log('礼物价格:', giftInfo.price);
```

### 2.2 使用新的礼物数据管理器

#### 2.2.1 导入礼物数据管理器

```javascript
// 导入礼物数据管理器
import * as giftManager from '@/global/utils/dydata/giftManager.js';

// 或者导入默认导出
import giftManager from '@/global/utils/dydata/giftManager.js';
```

#### 2.2.2 初始化礼物数据

```javascript
// 初始化礼物数据管理器
await giftManager.initGiftManager('317422'); // 传入房间ID
```

#### 2.2.3 获取礼物数据

```javascript
// 获取所有礼物数据
const allGiftData = giftManager.getAllGiftData();
console.log('礼物总数:', Object.keys(allGiftData).length);

// 根据ID获取礼物数据
const gift = giftManager.getGiftById('20417');
if (gift) {
  console.log('礼物名称:', gift.name);
  console.log('礼物价格:', gift.price);
  console.log('礼物图标:', gift.icon);
}

// 获取礼物分类标签
const tabs = giftManager.getGiftTabs();
console.log('礼物分类:', tabs.map(tab => tab.name).join(', '));

// 获取礼物公共配置
const commonConfig = giftManager.getGiftCommonConfig();
console.log('图片URL前缀:', commonConfig.picUrlPrefix);
```

#### 2.2.4 更新礼物数据

```javascript
// 更新礼物数据
const success = await giftManager.refreshGiftData('317422');
if (success) {
  console.log('礼物数据更新成功');
} else {
  console.log('礼物数据更新失败或未达到更新间隔');
}
```

#### 2.2.5 监听数据更新

```javascript
// 监听礼物数据更新事件
const unsubscribe = giftManager.onGiftDataUpdate(() => {
  console.log('礼物数据已更新');
  const allGiftData = giftManager.getAllGiftData();
  console.log('当前礼物总数:', Object.keys(allGiftData).length);
});

// 取消监听
// unsubscribe();
```

## 3. 辅助函数使用

### 3.1 格式化礼物价格

```javascript
import { formatGiftPrice } from '@/global/utils/dydata/giftHelper.js';

// 格式化礼物价格（单位：分）
const formattedPrice = formatGiftPrice(100); // 输出: "1.00 元"
const priceWithoutUnit = formatGiftPrice(100, false); // 输出: "1.00"
```

### 3.2 获取礼物图片URL

```javascript
import { getGiftImageUrl } from '@/global/utils/dydata/giftHelper.js';

// 获取礼物图片URL
const gift = {
  icon: '/dygift/2023/01/01/test.png'
};

const picUrlPrefix = 'https://gfs-op.douyucdn.cn';
const imageUrl = getGiftImageUrl(gift, picUrlPrefix);
console.log('礼物图片URL:', imageUrl); // 输出: "https://gfs-op.douyucdn.cn/dygift/2023/01/01/test.png"
```

### 3.3 礼物数据验证

```javascript
import { validateGiftData } from '@/global/utils/dydata/giftHelper.js';

// 验证礼物数据
const isValid = validateGiftData(giftData);
console.log('礼物数据是否有效:', isValid);
```

### 3.4 根据价格过滤礼物

```javascript
import { filterGiftsByPrice } from '@/global/utils/dydata/giftHelper.js';

// 过滤价格大于等于10元的礼物
const expensiveGifts = filterGiftsByPrice(allGiftData, 1000); // 1000分 = 10元
console.log('高价礼物数量:', Object.keys(expensiveGifts).length);
```

### 3.5 搜索礼物

```javascript
import { searchGifts } from '@/global/utils/dydata/giftHelper.js';

// 搜索礼物
const searchResults = searchGifts(allGiftData, '鱼丸');
console.log('搜索结果数量:', Object.keys(searchResults).length);
```

## 4. 在组件中使用

### 4.1 初始化礼物数据

```vue
<template>
  <div class="gift-demo">
    <h2>礼物数据管理示例</h2>
    <div v-if="isLoading">正在加载礼物数据...</div>
    <div v-else>
      <p>礼物总数: {{ totalGifts }}</p>
      <p>使用的是 {{ isUsingGeneratedData ? '构建时' : '运行时' }} 数据</p>
      <button @click="refreshGifts">刷新礼物数据</button>
      <div class="gift-list">
        <div v-for="gift in visibleGifts" :key="gift.id" class="gift-item">
          <img :src="getGiftImage(gift)" :alt="gift.name" class="gift-icon">
          <div class="gift-info">
            <div class="gift-name">{{ gift.name }}</div>
            <div class="gift-price">{{ formatPrice(gift.price) }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import * as giftManager from '@/global/utils/dydata/giftManager.js';
import { formatGiftPrice, getGiftImageUrl } from '@/global/utils/dydata/giftHelper.js';

const roomId = '317422';
const isLoading = ref(true);
const visibleGifts = ref([]);

// 计算属性
const totalGifts = computed(() => {
  return Object.keys(giftManager.getAllGiftData()).length;
});

const isUsingGeneratedData = computed(() => {
  const stats = giftManager.getGiftDataStats();
  return stats.isUsingGeneratedData;
});

// 初始化
onMounted(async () => {
  // 初始化礼物数据管理器
  await giftManager.initGiftManager(roomId);
  
  // 监听数据更新
  giftManager.onGiftDataUpdate(() => {
    updateVisibleGifts();
  });
  
  // 更新可见礼物
  updateVisibleGifts();
  isLoading.value = false;
});

// 更新可见礼物
const updateVisibleGifts = () => {
  const allGiftData = giftManager.getAllGiftData();
  visibleGifts.value = Object.values(allGiftData).slice(0, 10); // 只显示前10个礼物
};

// 刷新礼物数据
const refreshGifts = async () => {
  isLoading.value = true;
  await giftManager.refreshGiftData(roomId);
  updateVisibleGifts();
  isLoading.value = false;
};

// 获取礼物图片
const getGiftImage = (gift) => {
  const commonConfig = giftManager.getGiftCommonConfig();
  return getGiftImageUrl(gift, commonConfig.picUrlPrefix);
};

// 格式化价格
const formatPrice = (price) => {
  return formatGiftPrice(price);
};
</script>

<style scoped>
.gift-demo {
  padding: 20px;
}

.gift-list {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-top: 20px;
}

.gift-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 8px;
  width: 200px;
}

.gift-icon {
  width: 50px;
  height: 50px;
  object-fit: contain;
}

.gift-info {
  flex: 1;
}

.gift-name {
  font-weight: bold;
  margin-bottom: 5px;
}

.gift-price {
  color: #f00;
}
</style>
```

### 4.2 在WebSocket中使用

```javascript
import { useWebsocket } from '@/monitor/hooks/useWebsocket.js';
import * as giftManager from '@/global/utils/dydata/giftManager.js';

// 获取礼物数据
const allGiftData = giftManager.getAllGiftData();

// 初始化WebSocket
const { giftList, connectWs } = useWebsocket(options, allGiftData);

// 监听礼物数据更新，实时更新WebSocket使用的礼物数据
giftManager.onGiftDataUpdate(() => {
  const newGiftData = giftManager.getAllGiftData();
  // 更新WebSocket使用的礼物数据
  // 注意：实际实现中需要根据WebSocket钩子的设计来更新数据
});

// 连接WebSocket
connectWs(roomId);
```

## 5. 高级功能

### 5.1 获取礼物数据统计信息

```javascript
import { getGiftDataStats } from '@/global/utils/dydata/giftManager.js';

// 获取统计信息
const stats = getGiftDataStats();
console.log('统计信息:', stats);
```

### 5.2 检查礼物数据是否需要更新

```javascript
import { shouldUpdateGiftData } from '@/global/utils/dydata/giftManager.js';

// 检查是否需要更新
if (shouldUpdateGiftData()) {
  await giftManager.refreshGiftData(roomId);
}
```

### 5.3 获取礼物分类

```javascript
import { getGiftCategories } from '@/global/utils/dydata/giftHelper.js';

// 获取礼物分类
const tabs = giftManager.getGiftTabs();
const allGiftData = giftManager.getAllGiftData();
const categories = getGiftCategories(tabs, allGiftData);

console.log('礼物分类:', Object.keys(categories));
```

### 5.4 计算礼物总价值

```javascript
import { calculateTotalGiftValue } from '@/global/utils/dydata/giftHelper.js';

// 计算礼物总价值
const giftList = [
  { gfid: '20417', gfcnt: '1' },
  { gfid: '20418', gfcnt: '3' }
];
const totalValue = calculateTotalGiftValue(giftList, allGiftData);
console.log('总价值:', formatGiftPrice(totalValue));
```

## 6. 构建时数据生成

### 6.1 手动生成静态礼物数据

```bash
# 手动生成静态礼物数据
npm run generate-gift-data
```

### 6.2 构建项目时自动生成

```bash
# 构建项目时自动生成静态礼物数据
npm run build
```

## 7. 调试信息

### 7.1 查看礼物数据来源

```javascript
// 查看礼物数据统计信息，了解数据来源
const stats = giftManager.getGiftDataStats();
console.log('是否使用构建时数据:', stats.isUsingGeneratedData);
console.log('上次更新时间:', new Date(stats.lastUpdateTime).toLocaleString());
console.log('数据版本:', stats.version);
```

### 7.2 查看礼物数据详情

```javascript
// 获取礼物数据统计信息
const stats = giftManager.getGiftDataStats();
console.log('礼物数据统计:', stats);

// 查看礼物数据键
const allGiftData = giftManager.getAllGiftData();
console.log('礼物数据键:', Object.keys(allGiftData).slice(0, 10));
```

## 8. 注意事项

1. **开发环境**：在开发环境中，系统会自动获取运行时数据，确保获取最新的礼物信息
2. **生产环境**：在生产环境中，系统优先使用构建时生成的静态数据，确保部署兼容性
3. **更新频率**：礼物数据更新有频率限制（5分钟），避免频繁请求API
4. **房间ID**：获取运行时数据需要提供房间ID，建议从URL路径或全局状态中获取
5. **向后兼容**：原有代码无需修改即可使用新的礼物数据管理功能

通过以上示例，您可以充分利用新的礼物数据管理功能，获取最新的礼物数据，提升应用的实时性和用户体验。
